# 指标管理项目说明书（v1.1.0）

## 1. 项目概述
指标管理项目（Metric Management System，简称 MMS）旨在建立一套 **统一、标准化、可治理、可追溯的企业指标体系平台**。随着业务规模扩张，企业内部各部门逐渐形成大量重复、含义不一致、口径模糊的指标，这导致数据口径混乱、跨部门沟通成本上升、数据无法统一对齐。

本项目通过构建完整的指标注册、版本管理、口径管理、数据处理与指标计算体系，实现：
- 企业指标统一命名与注册
- 指标版本控制（解决口径变更问题）
- 可复用的口径组件体系
- 可追溯的公式与数据血缘
- 自动化的数据接入与清洗
- 稳定可靠的指标计算与对外输出能力

系统核心职能包括：
1. **指标定义与管理**：实现指标主数据、版本、口径、公式等完整治理；
2. **数据接入与指标生成**：对上传的 Excel/Csv 或外部数据源进行清洗、转换、计算，并生成最终指标值。

---

## 2. 系统功能总览

### 2.1 指标定义与治理
该模块围绕指标全生命周期管理展开，包括：
- **指标注册**：登记指标编码、名称、主题域、责任人等基础属性；
- **指标描述管理**：包括指标业务含义、计算目的、适用场景；
- **指标分类体系**：按主题域、业务线、层级等组织指标；
- **指标粒度（Grain）定义**：定义按哪些维度（如公司、产品、渠道）统计；
- **公式管理（SQL + DSL）**：存储指标计算逻辑；
- **指标血缘管理**：自动记录指标来源的数据表、字段、计算路径；
- **敏感度与权限控制**：基于 sensitivity 字段控制访问等级。

### 2.2 指标版本管理
业务指标往往会因口径调整而变更版本。版本管理实现：
- 新版本创建、草稿管理；
- 版本生效区间控制（effective_from / effective_to）；
- 配套口径列表维护；
- 配套公式版本化；
- 历史数据与新数据对应不同版本；
- 指标变更的追溯能力（如比较 v1 与 v2 差异）。

此机制可彻底解决企业中长期存在的“口径不一致”问题。

### 2.3 口径管理与复用
口径管理是指标体系中的核心治理能力：
- 口径可描述过滤条件、聚合逻辑、维度转换、计算规则；
- 多个指标可复用同一口径，提高一致性；
- 口径可按类型进行分类（过滤、计算、聚合等）；
- 版本化指标可按顺序绑定多个口径；
- 支持口径表达式覆盖（override），可在版本中对口径微调；
- 支持 SQL 与 DSL 两种表达方式，兼容性强。

### 2.4 数据接入与清洗
系统支持两种数据接入方式：
1. **用户上传文件（Excel/Csv）**
2. **外部系统 API 推送**

数据清洗流程包括：
- 字段校验（缺失、格式、类型）；
- 特殊值处理（Null、N/A、空格、异常字符）；
- 维度映射（公司、产品、渠道）；
- 组合维生成（dim_combo）；
- 数据去重；
- 质量评分（quality_score）。

### 2.5 指标计算引擎
基于 metric_version 的公式与口径列表执行指标计算：
- 按口径顺序执行每一步规则；
- 支持多源数据聚合（如订单表 + 客户表）；
- 支持表达式计算（DSL）；
- 支持 SQL 执行；
- 支持计算结果验证与质量评分；
- 最终写入 metric_value 表。

### 2.6 指标输出
指标值写入 metric_value 后可供：
- BI 报表取数；
- 数据 API 查询；
- 分析系统取数；
- 自动化监控（如指标异常报警）。

---

## 3. 系统整体架构

系统采用 **前后端分离 + 微服务 + 批流一体任务计算 + 指标治理中心** 的架构模式。

### 3.1 架构分层

```python
┌──────────────────────────────┐
│           前端应用层（FE）       │
│  - 指标管理后台（React/Vue）      │
│  - 指标查询分析界面              │
│  - 文件上传、版本对比、口径管理   │
└──────────────────────────────┘
┌──────────────────────────────┐
│           服务层（BE）         │
│  - Metric Service（指标服务）   │
│  - Version Service（版本服务）  │
│  - Caliber Service（口径服务）  │
│  - Upload Service（数据上传）   │
│  - Mapping Service（维度映射） │
│  - Compute Service（指标计算） │
└──────────────────────────────┘
┌──────────────────────────────┐
│      计算层（Compute Layer） │
│  - SQL 引擎（MySQL/ClickHouse）│
│  - DSL 执行器（自研）          │
│  - Spark/Flink（可选）         │
│  - Airflow 调度                │
└──────────────────────────────┘
┌──────────────────────────────┐
│          数据存储层           │
│  - 指标主数据表 metric        │
│  - 版本，口径，维度表         │
│  - 指标值表 metric_value      │
│  - 上传数据中间表             │
└──────────────────────────────┘
```

### 3.2 数据流（Data Flow）

1. 用户上传数据 → Upload Service
2. 系统执行清洗 → Mapping Service
3. 匹配维度 → dim_company / dim_product
4. 生成维度组合 → dim_combo
5. 调度任务计算 → Compute Service
6. 执行 DSL/SQL → Writing metric_value

### 3.3 任务流（Task Flow）

- Airflow 定时每天 0:00 调度所有指标
- 新版本发布后自动触发重新计算
- 上传文件时触发单次计算

------

## 4. 数据模型设计

本系统采用标准三层结构：
- **指标主数据层（metric）**：负责指标的注册信息；
- **指标版本与口径层（metric_version, metric_caliber 等）**；
- **指标结果层（metric_value）**：存储计算后的指标值；
- **维度体系层（dim_company, dim_product, dim_channel, dim_combo）**：提供维度治理能力。

数据模型实现以下特性：
- 指标强一致治理；
- 结构化的口径拆分；
- 可复用的维度体系；
- 可追溯版本链路；
- 灵活的数据结果结构。

---

## 5. 表结构与业务含义

### 5.1 metric — 指标注册表
该表用于记录一个指标的基础信息，是指标的主数据。

主要字段说明：

- **code**：指标唯一编码
- **name**：指标名称
- **description**：指标描述
- **type**：指标类型（如 ratio, count, amount 等）
- **unit**：计量单位
- **subject_area**：主题域，如“销售”、“财务”等
- **owner**：指标责任人
- **sensitivity**：敏感度等级

此表完成指标的基础属性管理，是所有指标治理流程的起点。

**扩展说明：**

- **type** 描述指标的统计类型（如金额类、数量类、占比类等），用于自动化单位处理；
- **subject_area** 可用于对指标按主题域分层，如“经营类”“风险类”；
- **owner** 用于指标责任人治理流程（指标由谁定义、谁负责）；
- **sensitivity** 用于访问控制（如财务指标敏感）。

### 5.2 metric_version — 指标版本表
用于存储指标在不同版本下的口径、公式、粒度等定义。支持指标因口径变更产生新版本。

关键字段：

- **metric_id**：关联 metric
- **version**：版本号（如 v1.0, v2.0）
- **status**：draft / active / retired
- **effective_from / effective_to**：版本有效期
- **grain**：指标粒度（JSON，描述指标按什么维度聚合）
- **formula_sql / formula_dsl**：指标公式
- **data_sources**：指标依赖的数据表

版本化的设计让指标能够按时间追溯并解决跨部门指标冲突问题。

**扩展说明：**
- **grain（粒度）** 描述指标存储维度，如：
  ```json
  {"company": true, "product": true, "channel": true, "period": "month"}
  ```
- **formula_sql** 和 **formula_dsl** 支持双轨逻辑：
  - DSL 便于可视化编辑；
  - SQL 适用于高复杂度场景。
- **data_sources** 记录指标引用的所有数据源表，便于血缘分析。

### 5.3 metric_caliber — 口径主数据表

口径是指标计算逻辑的组成部分。

字段说明：

- **code / name**：口径标识与名称
- **category**：口径分类，如：过滤口径、聚合口径、计算口径…
- **expr_dsl / expr_sql**：口径表达式
- **unit_override**：单位覆盖

口径的独立管理允许多个指标复用同一口径，提高治理效率。

**扩展说明：**
- 可将复杂指标拆解为多个口径单元，使公式更可治理；
- 例如，指标“边际贡献”可拆分为：`PTD-实际`、`QTD-实际`、`YTD-实际`；
- 支持以 DSL 格式表达条件、分支、聚合规则；
- 口径的粒度可能与指标一致或不同，系统会在执行时做自动对齐。

### 5.4 metric_version_caliber — 指标版本与口径绑定关系

指标版本会由多个口径组成，该表描述这种组合关系。

关键字段：

- **metric_version_id**：指标版本 ID
- **caliber_id**：口径 ID
- **order_index**：口径执行顺序
- **override_expr**：覆盖口径表达式

这让指标在每个版本中可由多个口径构成，且顺序可控、规则可重载。

**扩展说明：**
- 一个指标版本由多条口径组成，每条口径按 order_index 顺序执行；
- 可在版本级别覆盖口径表达式，用于小范围调整；
- 支持设置口径生效期，用于特例处理；
- 支持 override_data_sources，用于向指标追加额外来源。

### 5.5 metric_value — 指标值表
存储计算后的最终指标值，是对外查询指标的核心结果表。

主键由：

- metric_version_caliber_id
- period_date（统计周期）
- company_code
- dimensions_key（组合维）

**扩展说明：**
- 主键包含 period_date 与 dimensions_key，让指标可按“时间 + 维度组合”存储；
- 支持 actual / forecast 等状态；
- 支持 evidence_id，用于上传支撑材料，如审计要求；
- dimensions_key 与 dim_combo 相对应，用于多维度组合。

### 5.6 dim_combo — 多维组合维度表
用于将多个维表（公司、核心企业、产品、渠道）组合成一个组合维主键 combo_id。

组合关系：

```
一级公司 → 核心企业 → 产品 → 渠道
```

维度映射逻辑：

- 通过 dim_company、dim_product、dim_channel 维表组合生成
- 最终写入 metric_value.dimensions_key

**扩展说明：**
- 多个业务系统可能提供不同的维度组合方式，因此 dim_combo 提供一种标准化结构；
- 若某组合不存在即可自动创建；
- company → core_company → product → channel 的层级可用于集团级分析。

### 5.7 维度体系（dim_company / dim_product / dim_channel）
这些表提供维度值的主数据管理，用于在数据清洗阶段将用户上传的公司/产品/渠道映射为标准 ID。

#### dim_company

企业层级结构、公司编码信息

#### dim_product

产品映射与类型管理

#### dim_channel

渠道类型与层级

**维度体系扩展内容：**
- dim_company 记录集团公司树状结构，可用于集团分析；
- dim_product 记录产品线生命周期；
- dim_channel 提供渠道类型（江苏银行、华夏银行、农业银行等）。

---

## 6. 数据处理流程

### 6.1 数据接入流程
数据从外部进入系统后，系统会进行自动处理：
1. **Schema 验证**：确保文件格式符合要求；
2. **字段类型转换**：如字符串转日期、金额转 decimal；
3. **缺失数据判定与补全**；
4. **维度映射**：通过 dim_company、dim_product 等查找标准 ID；
5. **生成维度组合 dim_combo**；
6. **记录质量评分**；
7. **存储清洗后的中间数据**。

### 6.2 指标计算流程
根据 metric_version：
1. 加载版本信息、粒度、数据源；
2. 获取并排序所有绑定的口径；
3. 执行 DSL/SQL 公式；
4. 按粒度聚合；
5. 生成指标值并写入 metric_value。

### 6.3 数据输出流程
- 可通过内部 API 查询指标值；
- 提供以指标、维度、周期为条件的检索模式；
- 可通过数据接口导出给 BI、数据中台等系统；
- 可对指标设置订阅与监控报警。

---

## 7.API 文档

### 7.1 查询指标

```python
GET /api/metric/value
params:
  code: 指标编码
  date: 日期
  combo_id: 维度组合
```

### 7.2 注册指标

```python
POST /api/metric
body:
  code
  name
  type
  owner
```

### 7.3 发布版本

```python
POST /api/metric/version/publish
```

### 7.4 上传文件

```python
POST /api/upload
multipart/form-data
```

------

## 8.任务调度与计算框架

系统支持：

- **Airflow**：调度所有指标计算
- **Spark**：高并发计算
- **Flink**：实时指标流计算

调度模式：

- 全量调度
- 增量调度
- 上传触发调度

------

## 9.权限体系说明

权限基于：

1. **敏感度 sensitivity**
   - normal：所有人可见
   - confidential：仅部门负责人可见
   - secret：仅特定角色可见
2. **指标责任人 owner**
   - 负责审批修改
   - 负责发布版本
3. **数据权限**
   - 按公司层级授权（如仅能看所属区域）

------

## 10. 典型使用场景

### 场景 1：新增经营指标
1. 业务部门提出指标需求；
2. 在 metric 注册指标；
3. 运营/数据部门填写口径定义；
4. 系统创建 metric_version；
5. 配置粒度和公式；
6. 数据接入；
7. 指标计算并生成结果。

### 场景 2：指标口径变更（最常见）
1. 创建新 metric_version；
2. 修改或新增口径；
3. 设置生效日期；
4. 历史数据按旧版本，未来按新版本；
5. 自动生成差异对比报告（可选）。

### 场景 3：指标跨部门解释不一致
系统可查询：
- 指标主数据；
- 指标版本；
- 指标口径；
- 指标血缘；

从而明确部门之间为何指标不同。

---

## 11. 系统优势
- **指标跨部门统一**：彻底解决集团型企业指标不一致问题；
- **可复用口径**：提升治理效率；
- **版本化管理**：支持任意时间点追溯；
- **标准维度体系**：提升数据清洗和绑定效率；
- **高扩展性**：可接入任意 Excel/CSV 数据源；
- **可视化公式配置**：便于运营团队维护；
- **数据质量管理**：内置 quality_score；
- **可审计性**：通过 evidence_id 关联支撑材料。

---

## 12. 附录：SQL 表结构（略）


